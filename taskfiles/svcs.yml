version: "3"

vars:
  VERSION:
    sh: git describe --tags --abbrev=0
  COMMIT:
    sh: git rev-parse --short HEAD
  ROOT:
    sh: git rev-parse --show-toplevel
  OS:
    sh: uname -s
  DOPPLER_TOKEN:
    sh: skate get DOPPLER_NETWORK
tasks:
  start:
    desc: Start the network
    silent: true
    dir: "{{.ROOT}}"
    cmds:
      - task: start:darwin
      - task: start:linux

  stop:
    desc: Stop the network
    silent: true
    dir: "{{.ROOT}}"
    cmds:
      - task: stop:darwin
      - task: stop:linux

  start:darwin:
    internal: true
    silent: true
    dir: "{{.ROOT}}"
    platforms:
      - darwin
    cmds: 
    - devbox services start postgresql
    - make start

  start:linux:
    internal: true
    dir: "{{.ROOT}}"
    silent: true
    platforms:
      - linux
    cmd: make start-uds

  stop:darwin:
    internal: true
    silent: true
    dir: "{{.ROOT}}"
    platforms:
      - darwin
    cmd: make stop

  stop:linux:
    internal: true
    dir: "{{.ROOT}}"
    silent: true
    platforms:
      - linux
    cmds:
      - make stop-uds

  print:
    internal: true
    silent: true
    cmds:
      - gum format -- "# Sonr ({{.OS}}-{{.VERSION}})" "- ({{.COMMIT}})" "- {{.NOW}}" 
